# MCP Toolbox for Database Configuration for CareFlow Pulse
# Defines Firestore data source and patient management tools

sources:
  careflow-firestore:
    kind: "firestore"
    project: "careflow-478811"  # Google cloud project ID
    database: "careflow-db"  # Firestore database ID

tools:
  # Get patients for specific medication schedule
  get_patients_for_schedule:
    kind: firestore-query
    source: careflow-firestore
    description: "Retrieve all active patients for the hospital filtered by their call schedule hour (8, 12, or 20)."
    collectionPath: "patients"
    filters: |
      {
        "compositeFilter": {
          "op": "AND",
          "filters": [
            {
              "fieldFilter": {
                "field": "hospitalId",
                "op": "==",
                "value": {"stringValue": "{{.hospitalId}}"}
              }
            },
            {
              "fieldFilter": {
                "field": "status",
                "op": "==",
                "value": {"stringValue": "active"}
              }
            },
            {
              "fieldFilter": {
                "field": "scheduleHour",
                "op": "==",
                "value": {"integerValue": {{.scheduleHour}}}
              }
            }
          ]
        }
      }
    parameters:
      - name: hospitalId
        type: string
        description: "The Hospital ID to filter by"
        required: true
      - name: scheduleHour
        type: integer
        description: "The hour of the day (8, 12, 20) the patient is scheduled for rounds"
        required: true
  
  # Query patient by phone number
  get_patient_by_phone:
    kind: firestore-query
    source: careflow-firestore
    description: "Find a patient by their phone number for the hospital"
    collectionPath: "patients"
    filters: |
      {
        "compositeFilter": {
          "op": "AND",
          "filters": [
            {
              "fieldFilter": {
                "field": "hospitalId",
                "op": "==",
                "value": {"stringValue": "{{.hospitalId}}"}
              }
            },
            {
              "fieldFilter": {
                "field": "contact.phone",
                "op": "==",
                "value": {"stringValue": "{{.phoneNumber}}"}
              }
            }
          ]
        }
      }
    parameters:
      - name: hospitalId
        type: string
        description: "The Hospital ID to filter by"
        required: true
      - name: phoneNumber
        type: string
        description: "Patient's phone number"
        required: true
  
  # Query patient by name (for inbound calls)
  get_patient_by_name:
    kind: firestore-query
    source: careflow-firestore
    description: "Find a patient by their name for the hospital (used for inbound calls when patient identifies themselves)"
    collectionPath: "patients"
    filters: |
      {
        "compositeFilter": {
          "op": "AND",
          "filters": [
            {
              "fieldFilter": {
                "field": "hospitalId",
                "op": "==",
                "value": {"stringValue": "{{.hospitalId}}"}
              }
            },
            {
              "fieldFilter": {
                "field": "name",
                "op": "==",
                "value": {"stringValue": "{{.patientName}}"}
              }
            }
          ]
        }
      }
    parameters:
      - name: hospitalId
        type: string
        description: "The Hospital ID to filter by"
        required: true
      - name: patientName
        type: string
        description: "Patient's full name as stored in the database"
        required: true
  
  # List all collections (for discovery)
  list_collections:
     kind: firestore-list-collections
     source: careflow-firestore
     description: "List all available top-level collections in the Firestore database."

  # Log call interaction
  log_patient_interaction:
    kind: firestore-add-documents
    source: careflow-firestore
    description: >
      Log a call interaction to patient's subcollection.
      collectionPath: "patients/{patientId}/interactions"
      
      Fields:
      - timestamp: SERVER_TIMESTAMP
      - sender: "ai" | "patient" | "system"
      - content: Interaction summary
      - type: "message" | "event"
      - callSid: Twilio Call SID for audio

toolsets:
  patient_tools:
    - get_patients_for_schedule
    - get_patient_by_phone
    - get_patient_by_name
    - list_collections
    - log_patient_interaction
