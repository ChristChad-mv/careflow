
import asyncio
import os
import sys
import uuid
import logging
import base64
import glob
from datetime import datetime
from unittest.mock import patch

# Standard ADK/A2A Evaluation imports
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "../../../")))

from dotenv import load_dotenv
from a2a.types import Message, Role, Part, TextPart, MessageSendParams, FilePart, FileWithBytes
from a2a.server.agent_execution import RequestContext
from a2a.server.events import EventQueue

from app.agent import root_agent 
from app.app_utils.executor.careflow_executor import CareFlowAgentExecutor
from app.app_utils.prompts.system_prompts import CAREFLOW_SYSTEM_PROMPT

load_dotenv()
logging.basicConfig(level=logging.ERROR)

DATASET_DIR = os.path.join(os.path.dirname(__file__), "datasets")
REPORT_DIR = os.path.join(os.path.dirname(__file__), "reports")

class MockEventQueue(EventQueue):
    def __init__(self):
        self.events = []
    async def enqueue_event(self, event) -> None:
        self.events.append(event)

async def run_audio_eval():
    os.makedirs(REPORT_DIR, exist_ok=True)
    
    print(f"üéôÔ∏è  CareFlow Pulse - Production Logic Emulation")
    print(f"‚îÄ" * 60)
    
    audio_files = sorted(glob.glob(os.path.join(DATASET_DIR, "*.wav")))
    if not audio_files:
        print(f"‚ö†Ô∏è  No .wav files found in {DATASET_DIR}")
        return

    # Use the REAL system prompt
    root_agent.assistant.instruction = CAREFLOW_SYSTEM_PROMPT
    executor = CareFlowAgentExecutor(root_agent)

    for audio_path in audio_files:
        file_name = os.path.basename(audio_path)
        call_sid = os.path.splitext(file_name)[0]
        print(f"\n‚ñ∂Ô∏è  TESTING IN PROD CONDITIONS: {file_name}")
        
        with open(audio_path, "rb") as f:
            audio_b64 = base64.b64encode(f.read()).decode('utf-8')
        
        # EXACT PRODUCTION PROMPT
        prompt_text = (
            f"CALL_COMPLETE: Interview with patient Christ Chadrak (ID: dSwgjdP96YfPbCWYSyB3) finished. "
            f"Call SID: {call_sid}. Analyze the audio."
        )
        
        message = Message(
            messageId=str(uuid.uuid4()),
            kind="message",
            role=Role.user,
            parts=[
                Part(root=TextPart(kind="text", text=prompt_text)),
                Part(root=FilePart(kind="file", file=FileWithBytes(bytes=audio_b64, mime_type="audio/wav")))
            ]
        )
        
        context = RequestContext(
            request=MessageSendParams(message=message),
            context_id=f"eval-audio-{file_name}",
            task_id=str(uuid.uuid4())
        )
        mock_queue = MockEventQueue()
        
        print(f"‚åõ Gemini 3 is listening with Production Instructions...", end="", flush=True)
        
        agent_report = ""
        agent_reflection = ""
        
        try:
            # We mock the clinical tools to avoid actual DB writes during eval
            with patch("app.tools.clinical_tools.update_patient_risk") as mock_risk:
                
                mock_risk.return_value = "SUCCESS: Mocked risk update"
                
                await executor.execute(context, mock_queue)
            
            for event in mock_queue.events:
                if getattr(event, 'kind', '') == 'status-update' and getattr(event, 'final', False):
                    status = getattr(event, 'status', None)
                    if status and status.message:
                        if status.message.parts:
                            agent_report = "".join([p.root.text for p in status.message.parts if hasattr(p.root, 'text')])
                        metadata = getattr(status.message, 'metadata', {})
                        if metadata:
                            agent_reflection = metadata.get("reflection", "")
        except Exception as e:
            print(f" ‚ùå ERROR: {e}")
            continue

        print(" ‚úÖ")
        
        # Save Report
        report_base_name = os.path.splitext(file_name)[0]
        report_path = os.path.join(REPORT_DIR, f"{report_base_name}-PROD_EMU-report.md")
        
        with open(report_path, "w", encoding="utf-8") as rf:
            rf.write(f"# CareFlow Pulse - EMULATED PRODUCTION REPORT\n\n")
            rf.write(f"**Audio File:** `{file_name}`\n")
            rf.write(f"**Prompt Used:** `{prompt_text}`\n")
            rf.write(f"**Date:** `{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}`\n\n")
            
            rf.write(f"## üß† Agent Reflection (Thinking Signature)\n")
            rf.write(f"```text\n{agent_reflection if agent_reflection else 'No internal reflection captured.'}\n```\n\n")
            
            rf.write(f"## üìã Final Clinical Assessment\n")
            rf.write(f"{agent_report if agent_report else 'No assessment generated.'}\n\n")
            rf.write(f"---\n*Generated by CareFlow Multimodal Eval (PROD EMULATOR)*\n")

        print("‚îÄ" * 60)
        print(f"üìÑ Report saved: reports/{os.path.basename(report_path)}")
        print("‚îÄ" * 60)

if __name__ == "__main__":
    asyncio.run(run_audio_eval())
